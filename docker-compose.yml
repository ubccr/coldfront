version: '3.8'

services:

  nginx:
    image: nginx:latest
    container_name: nginx
    privileged: true
    ports:
      - "80:80"
      - "443:443"
    environment:
      SERVER_NAME: "coldfront.hpc"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./nginx/server.crt:/etc/nginx/ssl/server.crt
      - ./nginx/server.key:/etc/nginx/ssl/server.key
      - static_volume:/opt/static_root
    depends_on:
      - coldfront

  coldfront:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: coldfront
    privileged: true
    environment:
      DEBUG: "False"
      INITIAL_SETUP: "False" #<----- CHANGE TO FALSE AFTER THE FIRTS RUN
      LOAD_TEST_DATA: "False"
      DJANGO_SUPERUSER_USERNAME: "superuser"
      DJANGO_SUPERUSER_EMAIL: "mail@mail.example"
      DJANGO_SUPERUSER_PASSWORD: "password"
      PLUGIN_SLURM: "True"
      PLUGIN_STORAGE: "True"
      PLUGIN_AUTH_LDAP: "True"
      AUTH_LDAP_SERVER_URI: "ldaps://ldapserver"
      AUTH_LDAP_START_TLS: "False"
      AUTH_LDAP_BIND_DN: 'CN=aa,DC=aa,DC=aa'
      AUTH_LDAP_BIND_PASSWORD: 'secretpassword'
      AUTH_LDAP_USER_SEARCH_BASE: 'DC=aa,DC=aa'
      AUTH_LDAP_GROUP_SEARCH_BASE: 'cn=aa,ou=aa,dc=aa,dc=aa'
      AUTH_LDAP_MIRROR_GROUPS: "False"
      AUTH_LDAP_BIND_AS_AUTHENTICATING_USER: "False"
      ONDEMAND_URL: "http://ondemand.hpc"
      SECRET_KEY: "klajsfkljasdfkljasdfkljadsfjklads"
      DATABASE_HOST: 'coldfront_database'
      DATABASE_PORT: 3306
      DATABASE_NAME: 'coldfront'
      DATABASE_USER: 'coldfront'
      DATABASE_PASSWORD: 'nomoresecret'
      DB_URL: "mysql://${DATABASE_USER}:${DATABASE_PASSWORD}@${DATABASE_HOST}:${DATABASE_PORT}/${DATABASE_NAME}"      
      REDIS_HOST: "coldfront_redis"
      CENTER_NAME: "Blabla Cloud"
      CENTER_HELP_URL: "https://blabla.it/"
      PROJECT_ROOT: "/opt"
    volumes:
      - static_volume:/opt/static_root
      - /opt/coldfront/coldfront_dump:/opt/coldfront/coldfront_dump #this folder is used by script-export-coldfront
     #- ./coldfront.db:/opt/coldfront.db
    ports:
      - "8000:8000"

  coldfront_redis:
    privileged: true
    image: redis:latest
    container_name: coldfront_redis
    command: redis-server
    ports:
      - "6379:6379"

  coldfront_worker:
    privileged: true
    build:
      context: .
      dockerfile: Dockerfile
    container_name: coldfront_worker
    command: coldfront qcluster
    depends_on:
      - coldfront_redis
    environment:
      SECRET_KEY: "klajsfkljasdfkljasdfkljadsfjklads"
      DATABASE_HOST: 'coldfront_database'
      DATABASE_PORT: 3306
      DATABASE_NAME: 'coldfront'
      DATABASE_USER: 'coldfront'
      DATABASE_PASSWORD: 'nomoresecret'
      DB_URL: "mysql://${DATABASE_USER}:${DATABASE_PASSWORD}@${DATABASE_HOST}:${DATABASE_PORT}/${DATABASE_NAME}"   
      REDIS_HOST: "coldfront_redis" 
      Q_CLUSTER_NAME: "coldfront"
      Q_CLUSTER_TIMEOUT: "60"
#    volumes:
#      - ./coldfront.db:/opt/coldfront.db
   

  coldfront_database:
    privileged: true
    image: mariadb:latest
    container_name: coldfront_database
    environment:
      MYSQL_ROOT_PASSWORD: nomoresecret
      MYSQL_DATABASE: coldfront
      MYSQL_USER: coldfront
      MYSQL_PASSWORD: nomoresecret
    volumes:
      - mariadb_data:/var/lib/mysql
   

volumes:
  mariadb_data:      
  static_volume: