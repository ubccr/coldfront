{% extends "common/base.html" %} 
{% load crispy_forms_tags %}
{% load static %}


{% block title %}
Import Grant from ORCID
{% endblock %}

{% block content %}
<h1>Import Grant from ORCID</h1>

<div class="col" >
    <form method="GET" id="selected_users">
        {% csrf_token %}
        {{ grant_orcid_query_form|crispy }}
        <button id="search-btn" type="submit" class="btn btn-success btn-block">Import</button>
    </form>
</div>

<br/>

<div class="col" >
</div>
<div class="col" id="search_results" >
    <div class="card border-light">
      <div class="card-body">
        <div id="search_results_inner"></div>
      </div>
    </div>
</div>

<a class="btn btn-info" href="{% url 'grant-create-choice' project.pk %}" role="button">
  <i class="fas fa-search" aria-hidden="true"></i> Back to Search
</a>
<a class="btn btn-secondary" href="{% url 'project-detail' project.pk %}" role="button">
    <i class="fas fa-long-arrow-left" aria-hidden="true"></i> Back to Project
</a>

{% endblock %}


{% block javascript %} 
  {{ block.super }}

<script>
    $('#search-btn').on('click', function(event)
    {
      console.log("search-btn clicked");

      event.preventDefault();
      $('#search_results').show();
      $("#search_results_inner").html('<div class="alert alert-info text-center"><i class="fas fa-sync fa-spin fa-fw"></i> Searching</div>')
      create_post();
    });
  
    function create_post() {
      var users = [];
      $('input:checked').each(function () {
            users.push($(this).val());
          });

      var pk = "{{ project.pk }}";
      $.ajax({
          url : "/grant/project/" + pk + "/orcid-import-search-result/", // the endpoint
          type : "POST", // http method
          data : {
            form_info : JSON.stringify(users),
            csrfmiddlewaretoken: "{{ csrf_token }}"
          }, // data sent with the post request
          // handle a successful response
          success : function(data) {
              $('#search_results').show();
              $('#search_results_inner').html(data);
          },
  
          // handle a non-successful response
          error : function(xhr,errmsg,err) {
              $('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                  " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
              console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          }
      });
  };
  
  $(document).ready(function(){
    $('<br><input id="selectAll" class="check" type="checkbox"> <strong>Select All Users</strong>').insertAfter($("#div_id_users > label"))


    $("#selectAll").click(function () {
      $("input[name^='users']").prop('checked', $(this).prop('checked'));
    });

    $("input[name^='users']").click(function (ele) {
      var id = $(this).attr('id');
      if (id != "selectAll") {
        $("#selectAll").prop('checked', false);
      }
    });

    $('[data-toggle="popover"]').popover();

  });
  </script>

{% endblock %}